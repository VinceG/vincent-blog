---
title: "כמה עובדות בנוגע לפירצות האבטחה של PHPList והפריצה אל phpbb.com"
date: 2009-02-08 15:33:59
categories: 
- "PHP"
- "אבטחת מידע"
- "חדשות"
tags: 
- "phpbb"
- "phplist"
- "אבטחה"
- "פריצה"
---

לא מזמן אתר <a href="http://www.phpbb.com" target="_blank">phpbb.com</a> נפרץ על ידי האקר שמצא פירצה במערכת ה <a href="http://www.phplist.com" target="_blank">PHPList</a> שהאתר השתמש בו. ההאקר ביצע דריסה של משתנה גלובאלי מסויים שאפשר הרצה של <a href="http://www.milw0rm.com/exploits/7778" target="_blank">אקספלוייט</a> מסויים במערכת. פרטים מלאים בנוגע לפירצה ניתן למצוא <a href="http://hackedphpbb.blogspot.com/2009/01/place-holder.html" target="_blank">בקישור הבא</a> על ידי משהו שטוען שהוא זה שפרץ לאתר. מההסבר של אותו האקר ניתן להבין שההתקנה של <a href="http://www.php.net" target="_blank">PHP</a> שהייתה על השרתים של <a href="http://www.phpbb.com" target="_blank">phpbb.com</a> הייתה פחות או יותר התקנת ברירת המחדל של <a href="http://www.php.net" target="_blank">PHP</a> ללא שום תוספות אבטחה כמעט, אבל נדבר על זה בהמשך.

<!--more-->קודם כל ננסה להבין מה הייתה הפירצה ב <a href="http://www.phplist.com" target="_blank">PHPList</a> שגרמה לביצוע הדריסה של משתנה גלובאלי שאפשר להריץ קובץ סקריפט חיצוני במערכת, שטופל בצורה שגויה (כולל בהכרזה של <a href="http://www.phplist.com" target="_blank">PHPList</a> ) ולכן אפשרה לפירצה להחשף. הקוד שגרם לפירצה מוצג למטה אשר ממוקם ב admin/index.php

```
if (!ini_get("register_globals")
|| ini_get("register_globals") == "off") {
# fix register globals, for now, should be phased out gradually
# sure, this gets around the entire reason that register globals
# should be off, but going through three years of code takes a long time....
foreach ($_REQUEST as $key => $val) {
$$key = $val;
}
}
...
if (isset($_SERVER["ConfigFile"]) && is_file($_SERVER["ConfigFile"])) {
print '<!-- using '.$_SERVER["ConfigFile"].'-->'."\n";
include $_SERVER["ConfigFile"];
}
```

הקוד הזה מזהה אם register_globals כבוי (שזה כברירת מחדל מגרסא 4.2 של PHP) ובמקרה כזה "מחקה" את הפעולה של register_globals על ידי כך שהוא מבצע איטרציה על כל הערכים שנמצאים במשתנה הגלובאלי REQUEST_ ומגדיר אותם בתוך ערכים גלובאלים בפני עצמם. (בעצם יוצר את הערכים הגלובאלים כמו POST_ GET_ ואחרים). פעולה דומה נעשית בפרוייקטים רבים אחרים כדי "לחקות" את הפעולה של register_globals=on. בדרך כלל זה נעשה בתור "מודיפיקציה מהירה" כדי לגרום לתוכנה לעבוד כש register_globals=off . לפי ההערה המוצגת בקוד למעלה ניתן להבין ש PHPList גם השתמשו בזה מאותה הסיבה.

הבעיה כאן היא שהלולאה לא מבצעת שום בדיקה וסינון שמאפשרת להאקר "לדרוס" כל אחד ואחד מהמשתנים הגלובאלים (כמו GLOBALS, SERVER, ENV ...) על ידי הגדרתם מחדש של המשתנים בין אם זה דרך הקישור דרך מתודת POST או דרך המשתנה של COOKIES (עוגיות). הקוד למעלה אפשר לראות שהאקר יכול לדרוש את הערך של $_SERVER['ConfigFile'] מבחוץ. וזה מאפשר להאקר שליטה מלאה על פקודת include , שמאפשרת לו להוסיף קובץ חיצוני/חריג מבחוץ.

לצערי היוצר של האקספלוייט שהוזרק למערכת, צוות היוצרים של PHPList ומשתמשים רבים אחרים עדיין מאמינים ששימוש בפונקציות כמו is_file() או file_exists() מסביב לקובץ שמתווסף (פקודת ה include ) תיהיה מספיק טובה כדי לוודא שזהו קובץ מקומי ולא מרוחק ותמנע מהאקר להוסיף קבצים חיצוניים ופגיעים. לכן היוצר של האקספלוייט וההכרזה מטעם צוות האבטחה של PHPList מעריכים לא נכון שזוהי בעיה של הרצת קובץ חיצוני. למרות שבמציאות is_file ו file_exists ב PHP גם עובדים עם קישורים במידה והפרוטוקול של הקישור תומך בפקודת ה stat. ב PHP ה HTTP(S)/DATA/PHP://INPUT פרוטוקולי קישור לא תומכים בזה. אבל מ PHP 5.0 פרוטוקול קישור FTP כן נתמך בזה לכן _SERVER['ConfigFile'] מאפשר הוספה של קובץ חיצוני בעזרת קריאה לקובץ דרך פרוטוקול FTP.

יותר חשוב מזה גם יוצר האקספלוייט, וצוות PHPList או כל אחד אחר שדווח על זה לא הבין שהבעיה גדולה יותר מ _SERVER['ConfigFile'] לכן אין פלא שהפתרון של PHPList לבעיה הוא רק "מודיפיקציה" שמתקנת את הבעיה עם האקספלוייט הספציפי הזה ולא מוצאת פתרון לבעיה כולה.

```
if (isset($_REQUEST['_SERVER'])) { exit; }
```

הקוד למעלה מגן על משתני ה SERVER הגלובאלים בלבד. כל שאר המשתנים הגלובאלים עדיין לא מוגנים בפני פירצה. <strong>בגלל זה עדיין ניתן לבצע התקפות LFI/RFI והזרקות SQL כנגד הגרסא האחרונה של PHPList על ידי דריסה של משתנים גלובאלים אחרים.</strong>

<strong>התגוננות</strong>

התקפה זו בוצעה רק בגלל שההתקנה של PHP באתר phpbb.com לא הייתה מוגדרת בצורה מאובטחת. כל אפליקציה על אותו שרת צריכה להיות מופרדת אחת מהשנייה. הפעלה של open_basedir* , שזוהי הגדרה של PHP פשוטה, הייתה מספקת כדי למנוע הוספה של אווטרים מהתקנת הפורומים של PHPBB דרך המערכת של PHPList. בנוסף נטרול ההגדרות allow_url_fopen/allow_url_include בצירוף עם בדיקה בעזרת is_file היו מונעים הוספה של קובץ חיצוני דרך פקודת include. למרות שהזרקות SQL דרך דריסת המשתנים הגלובאלים עדיין הייתה נתנת לביצוע.

מצד שני ישנה דרך פשוטה ומהירה יותר להתגונן מפני פירצות על ידי דריסה של משתנים גלובאלים: פשוט להתקין את <a href="http://www.suhosin.org/">Suhosin</a> שמהווה בעצם תוסף אבטחה ל PHP. הוא יאתר, ירשום ויעצור פירצות כאלו של דריסה של משתנים גלובאלים ופירצות נוספות אחרות. מנהל אתר שמתקין את PHP כפי שהיא ללא הפא'ץ של <a href="http://www.suhosin.org/">Suhosin</a> והתוסף, הוא לא זהיר ואולי אפילו רשלן באיזשהו מקום.

<strong>שימו לב!</strong>

*open_basedir - שלא תבינו לא נכון - open_basedir לא מאובטח בצורה מספקת מפני הזרקה של קובץ חיצוני על גבי השרת, אבל הוא מקשה על ההזרקות הללו.
